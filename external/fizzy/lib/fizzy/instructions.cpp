// Fizzy: A fast WebAssembly interpreter
// Copyright 2019-2020 The Fizzy Authors.
// SPDX-License-Identifier: Apache-2.0

#include "instructions.hpp"

namespace fizzy
{
namespace
{
// Order of input parameters is the order they are popped from stack,
// which is consistent with the order in FuncType::inputs.
constexpr InstructionType instruction_type_table[256] = {
    // 5.4.1 Control instructions
    /* unreachable         = 0x00 */ {{}, {}},
    /* nop                 = 0x01 */ {{}, {}},
    /* block               = 0x02 */ {{}, {}},
    /* loop                = 0x03 */ {{}, {}},
    /* if_                 = 0x04 */ {{ValType::i32}, {}},
    /* else_               = 0x05 */ {{}, {}},
    /*                       0x06 */ {},
    /*                       0x07 */ {},
    /*                       0x08 */ {},
    /*                       0x09 */ {},
    /*                       0x0a */ {},
    /* end                 = 0x0b */ {{}, {}},
    /* br                  = 0x0c */ {{}, {}},
    /* br_if               = 0x0d */ {{ValType::i32}, {}},
    /* br_table            = 0x0e */ {{ValType::i32}, {}},
    /* return_             = 0x0f */ {{}, {}},

    /* call                = 0x10 */ {{}, {}},
    /* call_indirect       = 0x11 */ {{ValType::i32}, {}},

    /*                       0x12 */ {},
    /*                       0x13 */ {},
    /*                       0x14 */ {},
    /*                       0x15 */ {},
    /*                       0x16 */ {},
    /*                       0x17 */ {},
    /*                       0x18 */ {},
    /*                       0x19 */ {},

    // 5.4.2 Parametric instructions
    // Stack polymorphic instructions - validated at instruction handler in expression parser.
    /* drop                = 0x1a */ {{}, {}},
    /* select              = 0x1b */ {{ValType::i32}, {}},

    /*                       0x1c */ {},
    /*                       0x1d */ {},
    /*                       0x1e */ {},
    /*                       0x1f */ {},

    // 5.4.3 Variable instructions
    // Stack polymorphic instructions - validated at instruction handler in expression parser.
    /* local_get           = 0x20 */ {{}, {}},
    /* local_set           = 0x21 */ {{}, {}},
    /* local_tee           = 0x22 */ {{}, {}},
    /* global_get          = 0x23 */ {{}, {}},
    /* global_set          = 0x24 */ {{}, {}},

    /*                       0x25 */ {},
    /*                       0x26 */ {},
    /*                       0x27 */ {},

    // 5.4.4 Memory instructions
    /* i32_load            = 0x28 */ {{ValType::i32}, {ValType::i32}},
    /* i64_load            = 0x29 */ {{ValType::i32}, {ValType::i64}},
    /* f32_load            = 0x2a */ {{ValType::i32}, {ValType::f32}},
    /* f64_load            = 0x2b */ {{ValType::i32}, {ValType::f64}},
    /* i32_load8_s         = 0x2c */ {{ValType::i32}, {ValType::i32}},
    /* i32_load8_u         = 0x2d */ {{ValType::i32}, {ValType::i32}},
    /* i32_load16_s        = 0x2e */ {{ValType::i32}, {ValType::i32}},
    /* i32_load16_u        = 0x2f */ {{ValType::i32}, {ValType::i32}},
    /* i64_load8_s         = 0x30 */ {{ValType::i32}, {ValType::i64}},
    /* i64_load8_u         = 0x31 */ {{ValType::i32}, {ValType::i64}},
    /* i64_load16_s        = 0x32 */ {{ValType::i32}, {ValType::i64}},
    /* i64_load16_u        = 0x33 */ {{ValType::i32}, {ValType::i64}},
    /* i64_load32_s        = 0x34 */ {{ValType::i32}, {ValType::i64}},
    /* i64_load32_u        = 0x35 */ {{ValType::i32}, {ValType::i64}},
    /* i32_store           = 0x36 */ {{ValType::i32, ValType::i32}, {}},
    /* i64_store           = 0x37 */ {{ValType::i32, ValType::i64}, {}},
    /* f32_store           = 0x38 */ {{ValType::i32, ValType::f32}, {}},
    /* f64_store           = 0x39 */ {{ValType::i32, ValType::f64}, {}},
    /* i32_store8          = 0x3a */ {{ValType::i32, ValType::i32}, {}},
    /* i32_store16         = 0x3b */ {{ValType::i32, ValType::i32}, {}},
    /* i64_store8          = 0x3c */ {{ValType::i32, ValType::i64}, {}},
    /* i64_store16         = 0x3d */ {{ValType::i32, ValType::i64}, {}},
    /* i64_store32         = 0x3e */ {{ValType::i32, ValType::i64}, {}},
    /* memory_size         = 0x3f */ {{}, {ValType::i32}},
    /* memory_grow         = 0x40 */ {{ValType::i32}, {ValType::i32}},

    // 5.4.5 Numeric instructions
    /* i32_const           = 0x41 */ {{}, {ValType::i32}},
    /* i64_const           = 0x42 */ {{}, {ValType::i64}},
    /* f32_const           = 0x43 */ {{}, {ValType::f32}},
    /* f64_const           = 0x44 */ {{}, {ValType::f64}},

    /* i32_eqz             = 0x45 */ {{ValType::i32}, {ValType::i32}},
    /* i32_eq              = 0x46 */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_ne              = 0x47 */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_lt_s            = 0x48 */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_lt_u            = 0x49 */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_gt_s            = 0x4a */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_gt_u            = 0x4b */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_le_s            = 0x4c */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_le_u            = 0x4d */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_ge_s            = 0x4e */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_ge_u            = 0x4f */ {{ValType::i32, ValType::i32}, {ValType::i32}},

    /* i64_eqz             = 0x50 */ {{ValType::i64}, {ValType::i32}},
    /* i64_eq              = 0x51 */ {{ValType::i64, ValType::i64}, {ValType::i32}},
    /* i64_ne              = 0x52 */ {{ValType::i64, ValType::i64}, {ValType::i32}},
    /* i64_lt_s            = 0x53 */ {{ValType::i64, ValType::i64}, {ValType::i32}},
    /* i64_lt_u            = 0x54 */ {{ValType::i64, ValType::i64}, {ValType::i32}},
    /* i64_gt_s            = 0x55 */ {{ValType::i64, ValType::i64}, {ValType::i32}},
    /* i64_gt_u            = 0x56 */ {{ValType::i64, ValType::i64}, {ValType::i32}},
    /* i64_le_s            = 0x57 */ {{ValType::i64, ValType::i64}, {ValType::i32}},
    /* i64_le_u            = 0x58 */ {{ValType::i64, ValType::i64}, {ValType::i32}},
    /* i64_ge_s            = 0x59 */ {{ValType::i64, ValType::i64}, {ValType::i32}},
    /* i64_ge_u            = 0x5a */ {{ValType::i64, ValType::i64}, {ValType::i32}},

    /* f32_eq              = 0x5b */ {{ValType::f32, ValType::f32}, {ValType::i32}},
    /* f32_ne              = 0x5c */ {{ValType::f32, ValType::f32}, {ValType::i32}},
    /* f32_lt              = 0x5d */ {{ValType::f32, ValType::f32}, {ValType::i32}},
    /* f32_gt              = 0x5e */ {{ValType::f32, ValType::f32}, {ValType::i32}},
    /* f32_le              = 0x5f */ {{ValType::f32, ValType::f32}, {ValType::i32}},
    /* f32_ge              = 0x60 */ {{ValType::f32, ValType::f32}, {ValType::i32}},

    /* f64_eq              = 0x61 */ {{ValType::f64, ValType::f64}, {ValType::i32}},
    /* f64_ne              = 0x62 */ {{ValType::f64, ValType::f64}, {ValType::i32}},
    /* f64_lt              = 0x63 */ {{ValType::f64, ValType::f64}, {ValType::i32}},
    /* f64_gt              = 0x64 */ {{ValType::f64, ValType::f64}, {ValType::i32}},
    /* f64_le              = 0x65 */ {{ValType::f64, ValType::f64}, {ValType::i32}},
    /* f64_ge              = 0x66 */ {{ValType::f64, ValType::f64}, {ValType::i32}},

    /* i32_clz             = 0x67 */ {{ValType::i32}, {ValType::i32}},
    /* i32_ctz             = 0x68 */ {{ValType::i32}, {ValType::i32}},
    /* i32_popcnt          = 0x69 */ {{ValType::i32}, {ValType::i32}},
    /* i32_add             = 0x6a */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_sub             = 0x6b */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_mul             = 0x6c */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_div_s           = 0x6d */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_div_u           = 0x6e */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_rem_s           = 0x6f */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_rem_u           = 0x70 */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_and             = 0x71 */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_or              = 0x72 */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_xor             = 0x73 */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_shl             = 0x74 */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_shr_s           = 0x75 */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_shr_u           = 0x76 */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_rotl            = 0x77 */ {{ValType::i32, ValType::i32}, {ValType::i32}},
    /* i32_rotr            = 0x78 */ {{ValType::i32, ValType::i32}, {ValType::i32}},

    /* i64_clz             = 0x79 */ {{ValType::i64}, {ValType::i64}},
    /* i64_ctz             = 0x7a */ {{ValType::i64}, {ValType::i64}},
    /* i64_popcnt          = 0x7b */ {{ValType::i64}, {ValType::i64}},
    /* i64_add             = 0x7c */ {{ValType::i64, ValType::i64}, {ValType::i64}},
    /* i64_sub             = 0x7d */ {{ValType::i64, ValType::i64}, {ValType::i64}},
    /* i64_mul             = 0x7e */ {{ValType::i64, ValType::i64}, {ValType::i64}},
    /* i64_div_s           = 0x7f */ {{ValType::i64, ValType::i64}, {ValType::i64}},
    /* i64_div_u           = 0x80 */ {{ValType::i64, ValType::i64}, {ValType::i64}},
    /* i64_rem_s           = 0x81 */ {{ValType::i64, ValType::i64}, {ValType::i64}},
    /* i64_rem_u           = 0x82 */ {{ValType::i64, ValType::i64}, {ValType::i64}},
    /* i64_and             = 0x83 */ {{ValType::i64, ValType::i64}, {ValType::i64}},
    /* i64_or              = 0x84 */ {{ValType::i64, ValType::i64}, {ValType::i64}},
    /* i64_xor             = 0x85 */ {{ValType::i64, ValType::i64}, {ValType::i64}},
    /* i64_shl             = 0x86 */ {{ValType::i64, ValType::i64}, {ValType::i64}},
    /* i64_shr_s           = 0x87 */ {{ValType::i64, ValType::i64}, {ValType::i64}},
    /* i64_shr_u           = 0x88 */ {{ValType::i64, ValType::i64}, {ValType::i64}},
    /* i64_rotl            = 0x89 */ {{ValType::i64, ValType::i64}, {ValType::i64}},
    /* i64_rotr            = 0x8a */ {{ValType::i64, ValType::i64}, {ValType::i64}},

    /* f32_abs             = 0x8b */ {{ValType::f32}, {ValType::f32}},
    /* f32_neg             = 0x8c */ {{ValType::f32}, {ValType::f32}},
    /* f32_ceil            = 0x8d */ {{ValType::f32}, {ValType::f32}},
    /* f32_floor           = 0x8e */ {{ValType::f32}, {ValType::f32}},
    /* f32_trunc           = 0x8f */ {{ValType::f32}, {ValType::f32}},
    /* f32_nearest         = 0x90 */ {{ValType::f32}, {ValType::f32}},
    /* f32_sqrt            = 0x91 */ {{ValType::f32}, {ValType::f32}},
    /* f32_add             = 0x92 */ {{ValType::f32, ValType::f32}, {ValType::f32}},
    /* f32_sub             = 0x93 */ {{ValType::f32, ValType::f32}, {ValType::f32}},
    /* f32_mul             = 0x94 */ {{ValType::f32, ValType::f32}, {ValType::f32}},
    /* f32_div             = 0x95 */ {{ValType::f32, ValType::f32}, {ValType::f32}},
    /* f32_min             = 0x96 */ {{ValType::f32, ValType::f32}, {ValType::f32}},
    /* f32_max             = 0x97 */ {{ValType::f32, ValType::f32}, {ValType::f32}},
    /* f32_copysign        = 0x98 */ {{ValType::f32, ValType::f32}, {ValType::f32}},

    /* f64_abs             = 0x99 */ {{ValType::f64}, {ValType::f64}},
    /* f64_neg             = 0x9a */ {{ValType::f64}, {ValType::f64}},
    /* f64_ceil            = 0x9b */ {{ValType::f64}, {ValType::f64}},
    /* f64_floor           = 0x9c */ {{ValType::f64}, {ValType::f64}},
    /* f64_trunc           = 0x9d */ {{ValType::f64}, {ValType::f64}},
    /* f64_nearest         = 0x9e */ {{ValType::f64}, {ValType::f64}},
    /* f64_sqrt            = 0x9f */ {{ValType::f64}, {ValType::f64}},
    /* f64_add             = 0xa0 */ {{ValType::f64, ValType::f64}, {ValType::f64}},
    /* f64_sub             = 0xa1 */ {{ValType::f64, ValType::f64}, {ValType::f64}},
    /* f64_mul             = 0xa2 */ {{ValType::f64, ValType::f64}, {ValType::f64}},
    /* f64_div             = 0xa3 */ {{ValType::f64, ValType::f64}, {ValType::f64}},
    /* f64_min             = 0xa4 */ {{ValType::f64, ValType::f64}, {ValType::f64}},
    /* f64_max             = 0xa5 */ {{ValType::f64, ValType::f64}, {ValType::f64}},
    /* f64_copysign        = 0xa6 */ {{ValType::f64, ValType::f64}, {ValType::f64}},

    /* i32_wrap_i64        = 0xa7 */ {{ValType::i64}, {ValType::i32}},
    /* i32_trunc_f32_s     = 0xa8 */ {{ValType::f32}, {ValType::i32}},
    /* i32_trunc_f32_u     = 0xa9 */ {{ValType::f32}, {ValType::i32}},
    /* i32_trunc_f64_s     = 0xaa */ {{ValType::f64}, {ValType::i32}},
    /* i32_trunc_f64_u     = 0xab */ {{ValType::f64}, {ValType::i32}},
    /* i64_extend_i32_s    = 0xac */ {{ValType::i32}, {ValType::i64}},
    /* i64_extend_i32_u    = 0xad */ {{ValType::i32}, {ValType::i64}},
    /* i64_trunc_f32_s     = 0xae */ {{ValType::f32}, {ValType::i64}},
    /* i64_trunc_f32_u     = 0xaf */ {{ValType::f32}, {ValType::i64}},
    /* i64_trunc_f64_s     = 0xb0 */ {{ValType::f64}, {ValType::i64}},
    /* i64_trunc_f64_u     = 0xb1 */ {{ValType::f64}, {ValType::i64}},
    /* f32_convert_i32_s   = 0xb2 */ {{ValType::i32}, {ValType::f32}},
    /* f32_convert_i32_u   = 0xb3 */ {{ValType::i32}, {ValType::f32}},
    /* f32_convert_i64_s   = 0xb4 */ {{ValType::i64}, {ValType::f32}},
    /* f32_convert_i64_u   = 0xb5 */ {{ValType::i64}, {ValType::f32}},
    /* f32_demote_f64      = 0xb6 */ {{ValType::f64}, {ValType::f32}},
    /* f64_convert_i32_s   = 0xb7 */ {{ValType::i32}, {ValType::f64}},
    /* f64_convert_i32_u   = 0xb8 */ {{ValType::i32}, {ValType::f64}},
    /* f64_convert_i64_s   = 0xb9 */ {{ValType::i64}, {ValType::f64}},
    /* f64_convert_i64_u   = 0xba */ {{ValType::i64}, {ValType::f64}},
    /* f64_promote_f32     = 0xbb */ {{ValType::f32}, {ValType::f64}},
    /* i32_reinterpret_f32 = 0xbc */ {{ValType::f32}, {ValType::i32}},
    /* i64_reinterpret_f64 = 0xbd */ {{ValType::f64}, {ValType::i64}},
    /* f32_reinterpret_i32 = 0xbe */ {{ValType::i32}, {ValType::f32}},
    /* f64_reinterpret_i64 = 0xbf */ {{ValType::i64}, {ValType::f64}},
};

constexpr uint8_t instruction_max_align_table[256] = {
    // 5.4.1 Control instructions
    /* unreachable         = 0x00 */ 0,
    /* nop                 = 0x01 */ 0,
    /* block               = 0x02 */ 0,
    /* loop                = 0x03 */ 0,
    /* if_                 = 0x04 */ 0,
    /* else_               = 0x05 */ 0,
    /*                       0x06 */ 0,
    /*                       0x07 */ 0,
    /*                       0x08 */ 0,
    /*                       0x09 */ 0,
    /*                       0x0a */ 0,
    /* end                 = 0x0b */ 0,
    /* br                  = 0x0c */ 0,
    /* br_if               = 0x0d */ 0,
    /* br_table            = 0x0e */ 0,
    /* return_             = 0x0f */ 0,
    /* call                = 0x10 */ 0,
    /* call_indirect       = 0x11 */ 0,

    /*                       0x12 */ 0,
    /*                       0x13 */ 0,
    /*                       0x14 */ 0,
    /*                       0x15 */ 0,
    /*                       0x16 */ 0,
    /*                       0x17 */ 0,
    /*                       0x18 */ 0,
    /*                       0x19 */ 0,

    // 5.4.2 Parametric instructions
    /* drop                = 0x1a */ 0,
    /* select              = 0x1b */ 0,

    /*                       0x1c */ 0,
    /*                       0x1d */ 0,
    /*                       0x1e */ 0,
    /*                       0x1f */ 0,

    // 5.4.3 Variable instructions
    /* local_get           = 0x20 */ 0,
    /* local_set           = 0x21 */ 0,
    /* local_tee           = 0x22 */ 0,
    /* global_get          = 0x23 */ 0,
    /* global_set          = 0x24 */ 0,

    /*                       0x25 */ 0,
    /*                       0x26 */ 0,
    /*                       0x27 */ 0,

    // 5.4.4 Memory instructions
    /* i32_load            = 0x28 */ 2,
    /* i64_load            = 0x29 */ 3,
    /* f32_load            = 0x2a */ 2,
    /* f64_load            = 0x2b */ 3,
    /* i32_load8_s         = 0x2c */ 0,
    /* i32_load8_u         = 0x2d */ 0,
    /* i32_load16_s        = 0x2e */ 1,
    /* i32_load16_u        = 0x2f */ 1,
    /* i64_load8_s         = 0x30 */ 0,
    /* i64_load8_u         = 0x31 */ 0,
    /* i64_load16_s        = 0x32 */ 1,
    /* i64_load16_u        = 0x33 */ 1,
    /* i64_load32_s        = 0x34 */ 2,
    /* i64_load32_u        = 0x35 */ 2,
    /* i32_store           = 0x36 */ 2,
    /* i64_store           = 0x37 */ 3,
    /* f32_store           = 0x38 */ 2,
    /* f64_store           = 0x39 */ 3,
    /* i32_store8          = 0x3a */ 0,
    /* i32_store16         = 0x3b */ 1,
    /* i64_store8          = 0x3c */ 0,
    /* i64_store16         = 0x3d */ 1,
    /* i64_store32         = 0x3e */ 2,
    /* memory_size         = 0x3f */ 0,
    /* memory_grow         = 0x40 */ 0,

    // 5.4.5 Numeric instructions
    /* i32_const           = 0x41 */ 0,
    /* i64_const           = 0x42 */ 0,
    /* f32_const           = 0x43 */ 0,
    /* f64_const           = 0x44 */ 0,

    /* i32_eqz             = 0x45 */ 0,
    /* i32_eq              = 0x46 */ 0,
    /* i32_ne              = 0x47 */ 0,
    /* i32_lt_s            = 0x48 */ 0,
    /* i32_lt_u            = 0x49 */ 0,
    /* i32_gt_s            = 0x4a */ 0,
    /* i32_gt_u            = 0x4b */ 0,
    /* i32_le_s            = 0x4c */ 0,
    /* i32_le_u            = 0x4d */ 0,
    /* i32_ge_s            = 0x4e */ 0,
    /* i32_ge_u            = 0x4f */ 0,

    /* i64_eqz             = 0x50 */ 0,
    /* i64_eq              = 0x51 */ 0,
    /* i64_ne              = 0x52 */ 0,
    /* i64_lt_s            = 0x53 */ 0,
    /* i64_lt_u            = 0x54 */ 0,
    /* i64_gt_s            = 0x55 */ 0,
    /* i64_gt_u            = 0x56 */ 0,
    /* i64_le_s            = 0x57 */ 0,
    /* i64_le_u            = 0x58 */ 0,
    /* i64_ge_s            = 0x59 */ 0,
    /* i64_ge_u            = 0x5a */ 0,

    /* f32_eq              = 0x5b */ 0,
    /* f32_ne              = 0x5c */ 0,
    /* f32_lt              = 0x5d */ 0,
    /* f32_gt              = 0x5e */ 0,
    /* f32_le              = 0x5f */ 0,
    /* f32_ge              = 0x60 */ 0,

    /* f64_eq              = 0x61 */ 0,
    /* f64_ne              = 0x62 */ 0,
    /* f64_lt              = 0x63 */ 0,
    /* f64_gt              = 0x64 */ 0,
    /* f64_le              = 0x65 */ 0,
    /* f64_ge              = 0x66 */ 0,

    /* i32_clz             = 0x67 */ 0,
    /* i32_ctz             = 0x68 */ 0,
    /* i32_popcnt          = 0x69 */ 0,
    /* i32_add             = 0x6a */ 0,
    /* i32_sub             = 0x6b */ 0,
    /* i32_mul             = 0x6c */ 0,
    /* i32_div_s           = 0x6d */ 0,
    /* i32_div_u           = 0x6e */ 0,
    /* i32_rem_s           = 0x6f */ 0,
    /* i32_rem_u           = 0x70 */ 0,
    /* i32_and             = 0x71 */ 0,
    /* i32_or              = 0x72 */ 0,
    /* i32_xor             = 0x73 */ 0,
    /* i32_shl             = 0x74 */ 0,
    /* i32_shr_s           = 0x75 */ 0,
    /* i32_shr_u           = 0x76 */ 0,
    /* i32_rotl            = 0x77 */ 0,
    /* i32_rotr            = 0x78 */ 0,

    /* i64_clz             = 0x79 */ 0,
    /* i64_ctz             = 0x7a */ 0,
    /* i64_popcnt          = 0x7b */ 0,
    /* i64_add             = 0x7c */ 0,
    /* i64_sub             = 0x7d */ 0,
    /* i64_mul             = 0x7e */ 0,
    /* i64_div_s           = 0x7f */ 0,
    /* i64_div_u           = 0x80 */ 0,
    /* i64_rem_s           = 0x81 */ 0,
    /* i64_rem_u           = 0x82 */ 0,
    /* i64_and             = 0x83 */ 0,
    /* i64_or              = 0x84 */ 0,
    /* i64_xor             = 0x85 */ 0,
    /* i64_shl             = 0x86 */ 0,
    /* i64_shr_s           = 0x87 */ 0,
    /* i64_shr_u           = 0x88 */ 0,
    /* i64_rotl            = 0x89 */ 0,
    /* i64_rotr            = 0x8a */ 0,

    /* f32_abs             = 0x8b */ 0,
    /* f32_neg             = 0x8c */ 0,
    /* f32_ceil            = 0x8d */ 0,
    /* f32_floor           = 0x8e */ 0,
    /* f32_trunc           = 0x8f */ 0,
    /* f32_nearest         = 0x90 */ 0,
    /* f32_sqrt            = 0x91 */ 0,
    /* f32_add             = 0x92 */ 0,
    /* f32_sub             = 0x93 */ 0,
    /* f32_mul             = 0x94 */ 0,
    /* f32_div             = 0x95 */ 0,
    /* f32_min             = 0x96 */ 0,
    /* f32_max             = 0x97 */ 0,
    /* f32_copysign        = 0x98 */ 0,

    /* f64_abs             = 0x99 */ 0,
    /* f64_neg             = 0x9a */ 0,
    /* f64_ceil            = 0x9b */ 0,
    /* f64_floor           = 0x9c */ 0,
    /* f64_trunc           = 0x9d */ 0,
    /* f64_nearest         = 0x9e */ 0,
    /* f64_sqrt            = 0x9f */ 0,
    /* f64_add             = 0xa0 */ 0,
    /* f64_sub             = 0xa1 */ 0,
    /* f64_mul             = 0xa2 */ 0,
    /* f64_div             = 0xa3 */ 0,
    /* f64_min             = 0xa4 */ 0,
    /* f64_max             = 0xa5 */ 0,
    /* f64_copysign        = 0xa6 */ 0,

    /* i32_wrap_i64        = 0xa7 */ 0,
    /* i32_trunc_f32_s     = 0xa8 */ 0,
    /* i32_trunc_f32_u     = 0xa9 */ 0,
    /* i32_trunc_f64_s     = 0xaa */ 0,
    /* i32_trunc_f64_u     = 0xab */ 0,
    /* i64_extend_i32_s    = 0xac */ 0,
    /* i64_extend_i32_u    = 0xad */ 0,
    /* i64_trunc_f32_s     = 0xae */ 0,
    /* i64_trunc_f32_u     = 0xaf */ 0,
    /* i64_trunc_f64_s     = 0xb0 */ 0,
    /* i64_trunc_f64_u     = 0xb1 */ 0,
    /* f32_convert_i32_s   = 0xb2 */ 0,
    /* f32_convert_i32_u   = 0xb3 */ 0,
    /* f32_convert_i64_s   = 0xb4 */ 0,
    /* f32_convert_i64_u   = 0xb5 */ 0,
    /* f32_demote_f64      = 0xb6 */ 0,
    /* f64_convert_i32_s   = 0xb7 */ 0,
    /* f64_convert_i32_u   = 0xb8 */ 0,
    /* f64_convert_i64_s   = 0xb9 */ 0,
    /* f64_convert_i64_u   = 0xba */ 0,
    /* f64_promote_f32     = 0xbb */ 0,
    /* i32_reinterpret_f32 = 0xbc */ 0,
    /* i64_reinterpret_f64 = 0xbd */ 0,
    /* f32_reinterpret_i32 = 0xbe */ 0,
    /* f64_reinterpret_i64 = 0xbf */ 0,
};

constexpr int16_t instruction_cost_table[256] = {
    // 5.4.1 Control instructions
    /* unreachable         = 0x00 */ 1,
    /* nop                 = 0x01 */ 1,
    /* block               = 0x02 */ 1,
    /* loop                = 0x03 */ 1,
    /* if_                 = 0x04 */ 1,
    /* else_               = 0x05 */ 1,
    /*                       0x06 */ 1,
    /*                       0x07 */ 1,
    /*                       0x08 */ 1,
    /*                       0x09 */ 1,
    /*                       0x0a */ 1,
    /* end                 = 0x0b */ 1,
    /* br                  = 0x0c */ 1,
    /* br_if               = 0x0d */ 1,
    /* br_table            = 0x0e */ 1,
    /* return_             = 0x0f */ 1,
    /* call                = 0x10 */ 1,
    /* call_indirect       = 0x11 */ 1,

    /*                       0x12 */ 1,
    /*                       0x13 */ 1,
    /*                       0x14 */ 1,
    /*                       0x15 */ 1,
    /*                       0x16 */ 1,
    /*                       0x17 */ 1,
    /*                       0x18 */ 1,
    /*                       0x19 */ 1,

    // 5.4.2 Parametric instructions
    /* drop                = 0x1a */ 1,
    /* select              = 0x1b */ 1,

    /*                       0x1c */ 1,
    /*                       0x1d */ 1,
    /*                       0x1e */ 1,
    /*                       0x1f */ 1,

    // 5.4.3 Variable instructions
    /* local_get           = 0x20 */ 1,
    /* local_set           = 0x21 */ 1,
    /* local_tee           = 0x22 */ 1,
    /* global_get          = 0x23 */ 1,
    /* global_set          = 0x24 */ 1,

    /*                       0x25 */ 1,
    /*                       0x26 */ 1,
    /*                       0x27 */ 1,

    // 5.4.4 Memory instructions
    /* i32_load            = 0x28 */ 1,
    /* i64_load            = 0x29 */ 1,
    /* f32_load            = 0x2a */ 1,
    /* f64_load            = 0x2b */ 1,
    /* i32_load8_s         = 0x2c */ 1,
    /* i32_load8_u         = 0x2d */ 1,
    /* i32_load16_s        = 0x2e */ 1,
    /* i32_load16_u        = 0x2f */ 1,
    /* i64_load8_s         = 0x30 */ 1,
    /* i64_load8_u         = 0x31 */ 1,
    /* i64_load16_s        = 0x32 */ 1,
    /* i64_load16_u        = 0x33 */ 1,
    /* i64_load32_s        = 0x34 */ 1,
    /* i64_load32_u        = 0x35 */ 1,
    /* i32_store           = 0x36 */ 1,
    /* i64_store           = 0x37 */ 1,
    /* f32_store           = 0x38 */ 1,
    /* f64_store           = 0x39 */ 1,
    /* i32_store8          = 0x3a */ 1,
    /* i32_store16         = 0x3b */ 1,
    /* i64_store8          = 0x3c */ 1,
    /* i64_store16         = 0x3d */ 1,
    /* i64_store32         = 0x3e */ 1,
    /* memory_size         = 0x3f */ 1,
    /* memory_grow         = 0x40 */ 1,

    // 5.4.5 Numeric instructions
    /* i32_const           = 0x41 */ 1,
    /* i64_const           = 0x42 */ 1,
    /* f32_const           = 0x43 */ 1,
    /* f64_const           = 0x44 */ 1,

    /* i32_eqz             = 0x45 */ 1,
    /* i32_eq              = 0x46 */ 1,
    /* i32_ne              = 0x47 */ 1,
    /* i32_lt_s            = 0x48 */ 1,
    /* i32_lt_u            = 0x49 */ 1,
    /* i32_gt_s            = 0x4a */ 1,
    /* i32_gt_u            = 0x4b */ 1,
    /* i32_le_s            = 0x4c */ 1,
    /* i32_le_u            = 0x4d */ 1,
    /* i32_ge_s            = 0x4e */ 1,
    /* i32_ge_u            = 0x4f */ 1,

    /* i64_eqz             = 0x50 */ 1,
    /* i64_eq              = 0x51 */ 1,
    /* i64_ne              = 0x52 */ 1,
    /* i64_lt_s            = 0x53 */ 1,
    /* i64_lt_u            = 0x54 */ 1,
    /* i64_gt_s            = 0x55 */ 1,
    /* i64_gt_u            = 0x56 */ 1,
    /* i64_le_s            = 0x57 */ 1,
    /* i64_le_u            = 0x58 */ 1,
    /* i64_ge_s            = 0x59 */ 1,
    /* i64_ge_u            = 0x5a */ 1,

    /* f32_eq              = 0x5b */ 1,
    /* f32_ne              = 0x5c */ 1,
    /* f32_lt              = 0x5d */ 1,
    /* f32_gt              = 0x5e */ 1,
    /* f32_le              = 0x5f */ 1,
    /* f32_ge              = 0x60 */ 1,

    /* f64_eq              = 0x61 */ 1,
    /* f64_ne              = 0x62 */ 1,
    /* f64_lt              = 0x63 */ 1,
    /* f64_gt              = 0x64 */ 1,
    /* f64_le              = 0x65 */ 1,
    /* f64_ge              = 0x66 */ 1,

    /* i32_clz             = 0x67 */ 1,
    /* i32_ctz             = 0x68 */ 1,
    /* i32_popcnt          = 0x69 */ 1,
    /* i32_add             = 0x6a */ 1,
    /* i32_sub             = 0x6b */ 1,
    /* i32_mul             = 0x6c */ 1,
    /* i32_div_s           = 0x6d */ 1,
    /* i32_div_u           = 0x6e */ 1,
    /* i32_rem_s           = 0x6f */ 1,
    /* i32_rem_u           = 0x70 */ 1,
    /* i32_and             = 0x71 */ 1,
    /* i32_or              = 0x72 */ 1,
    /* i32_xor             = 0x73 */ 1,
    /* i32_shl             = 0x74 */ 1,
    /* i32_shr_s           = 0x75 */ 1,
    /* i32_shr_u           = 0x76 */ 1,
    /* i32_rotl            = 0x77 */ 1,
    /* i32_rotr            = 0x78 */ 1,

    /* i64_clz             = 0x79 */ 1,
    /* i64_ctz             = 0x7a */ 1,
    /* i64_popcnt          = 0x7b */ 1,
    /* i64_add             = 0x7c */ 1,
    /* i64_sub             = 0x7d */ 1,
    /* i64_mul             = 0x7e */ 1,
    /* i64_div_s           = 0x7f */ 1,
    /* i64_div_u           = 0x80 */ 1,
    /* i64_rem_s           = 0x81 */ 1,
    /* i64_rem_u           = 0x82 */ 1,
    /* i64_and             = 0x83 */ 1,
    /* i64_or              = 0x84 */ 1,
    /* i64_xor             = 0x85 */ 1,
    /* i64_shl             = 0x86 */ 1,
    /* i64_shr_s           = 0x87 */ 1,
    /* i64_shr_u           = 0x88 */ 1,
    /* i64_rotl            = 0x89 */ 1,
    /* i64_rotr            = 0x8a */ 1,

    /* f32_abs             = 0x8b */ 1,
    /* f32_neg             = 0x8c */ 1,
    /* f32_ceil            = 0x8d */ 1,
    /* f32_floor           = 0x8e */ 1,
    /* f32_trunc           = 0x8f */ 1,
    /* f32_nearest         = 0x90 */ 1,
    /* f32_sqrt            = 0x91 */ 1,
    /* f32_add             = 0x92 */ 1,
    /* f32_sub             = 0x93 */ 1,
    /* f32_mul             = 0x94 */ 1,
    /* f32_div             = 0x95 */ 1,
    /* f32_min             = 0x96 */ 1,
    /* f32_max             = 0x97 */ 1,
    /* f32_copysign        = 0x98 */ 1,

    /* f64_abs             = 0x99 */ 1,
    /* f64_neg             = 0x9a */ 1,
    /* f64_ceil            = 0x9b */ 1,
    /* f64_floor           = 0x9c */ 1,
    /* f64_trunc           = 0x9d */ 1,
    /* f64_nearest         = 0x9e */ 1,
    /* f64_sqrt            = 0x9f */ 1,
    /* f64_add             = 0xa0 */ 1,
    /* f64_sub             = 0xa1 */ 1,
    /* f64_mul             = 0xa2 */ 1,
    /* f64_div             = 0xa3 */ 1,
    /* f64_min             = 0xa4 */ 1,
    /* f64_max             = 0xa5 */ 1,
    /* f64_copysign        = 0xa6 */ 1,

    /* i32_wrap_i64        = 0xa7 */ 1,
    /* i32_trunc_f32_s     = 0xa8 */ 1,
    /* i32_trunc_f32_u     = 0xa9 */ 1,
    /* i32_trunc_f64_s     = 0xaa */ 1,
    /* i32_trunc_f64_u     = 0xab */ 1,
    /* i64_extend_i32_s    = 0xac */ 1,
    /* i64_extend_i32_u    = 0xad */ 1,
    /* i64_trunc_f32_s     = 0xae */ 1,
    /* i64_trunc_f32_u     = 0xaf */ 1,
    /* i64_trunc_f64_s     = 0xb0 */ 1,
    /* i64_trunc_f64_u     = 0xb1 */ 1,
    /* f32_convert_i32_s   = 0xb2 */ 1,
    /* f32_convert_i32_u   = 0xb3 */ 1,
    /* f32_convert_i64_s   = 0xb4 */ 1,
    /* f32_convert_i64_u   = 0xb5 */ 1,
    /* f32_demote_f64      = 0xb6 */ 1,
    /* f64_convert_i32_s   = 0xb7 */ 1,
    /* f64_convert_i32_u   = 0xb8 */ 1,
    /* f64_convert_i64_s   = 0xb9 */ 1,
    /* f64_convert_i64_u   = 0xba */ 1,
    /* f64_promote_f32     = 0xbb */ 1,
    /* i32_reinterpret_f32 = 0xbc */ 1,
    /* i64_reinterpret_f64 = 0xbd */ 1,
    /* f32_reinterpret_i32 = 0xbe */ 1,
    /* f64_reinterpret_i64 = 0xbf */ 1,
};
}  // namespace

const InstructionType* get_instruction_type_table() noexcept
{
    return instruction_type_table;
}

const uint8_t* get_instruction_max_align_table() noexcept
{
    return instruction_max_align_table;
}

const int16_t* get_instruction_cost_table() noexcept
{
    return instruction_cost_table;
}
}  // namespace fizzy
